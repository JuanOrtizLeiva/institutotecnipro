<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asesor Virtual Instituto Tecnipro</title>
    <!-- Añadimos Font Awesome para iconos profesionales -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- Estilos Profesionales Mejorados --- */
        :root {
            --primary-color: #0056b3;
            --primary-color-hover: #004494;
            --accent-color: #28a745;
            --accent-color-hover: #218838;
            --light-bg: #f8f9fa;
            --chat-bg: #e9ebee;
            --user-bubble: #0072ce;
            --ai-bubble: #f0f0f0;
            --text-dark: #333333;
            --text-light: #ffffff;
            --border-color: #dee2e6;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            --radius-sm: 8px;
            --radius-md: 16px;
            --radius-lg: 24px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--light-bg);
            color: var(--text-dark);
            line-height: 1.5;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        #chat-container {
            display: flex;
            flex-direction: column;
            width: 100%;
            max-width: 800px; /* Aumentamos el ancho máximo para Wix */
            height: 600px; /* Altura fija para mejor visualización */
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow);
            background-color: #ffffff;
            position: relative; /* Para posicionar elementos absolutos */
        }

        #chat-header {
            background-color: var(--primary-color);
            color: var(--text-light);
            padding: 18px 25px;
            font-size: 1.2em;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            border-bottom: 1px solid var(--primary-color-hover);
        }

        #chat-header i {
            margin-right: 12px;
            font-size: 1.4em;
        }

        #chat-output {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            background-color: var(--chat-bg);
            display: flex;
            flex-direction: column;
            scroll-behavior: smooth;
        }

        .message {
            margin-bottom: 16px;
            padding: 14px 18px;
            border-radius: var(--radius-md);
            max-width: 80%;
            line-height: 1.5;
            position: relative;
            word-wrap: break-word;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .user-message {
            align-self: flex-end;
            background-color: var(--user-bubble);
            color: var(--text-light);
            border-bottom-right-radius: 4px;
        }

        .ai-message {
            align-self: flex-start;
            background-color: var(--ai-bubble);
            color: var(--text-dark);
            border-bottom-left-radius: 4px;
        }

        .message strong {
            font-weight: 600;
            margin-right: 8px;
            opacity: 0.8;
            font-size: 0.9em;
        }

        #loading-container {
            padding: 15px;
            background-color: rgba(255, 255, 255, 0.9);
            border-top: 1px solid var(--border-color);
            display: none;
            align-items: center;
            justify-content: center;
        }

        #loading-animation {
            display: flex;
            align-items: center;
            margin-right: 15px;
        }

        .typing-indicator {
            display: flex;
            align-items: center;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            margin: 0 2px;
            background-color: var(--primary-color);
            border-radius: 50%;
            animation: typingAnimation 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: 0s; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typingAnimation {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-8px); }
        }

        #loading-text {
            font-style: italic;
            color: var(--text-dark);
            font-size: 0.95em;
        }

        #chat-input-area {
            display: flex;
            padding: 16px;
            border-top: 1px solid var(--border-color);
            background-color: white;
            align-items: center;
            position: relative;
        }

        #user-input {
            flex-grow: 1;
            padding: 14px 18px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            font-size: 1em;
            outline: none;
            transition: all 0.3s ease;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        #user-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 86, 179, 0.15);
        }

        #send-button {
            padding: 14px 24px;
            margin-left: 12px;
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: var(--radius-lg);
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #send-button i {
            margin-left: 8px;
        }

        #send-button:hover {
            background-color: var(--accent-color-hover);
            transform: translateY(-1px);
        }

        #send-button:active {
            transform: translateY(0px);
        }

        #send-button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            transform: none;
        }

        /* Responsividad mejorada */
        @media (max-width: 768px) {
            #chat-container {
                height: 90vh;
                max-height: none;
                border-radius: var(--radius-md);
            }

            .message {
                max-width: 85%;
            }

            #send-button {
                padding: 14px 18px;
            }

            #send-button span {
                display: none;
            }
        }

        @media (max-width: 480px) {
            #chat-container {
                height: calc(100vh - 40px);
                border-radius: var(--radius-sm);
            }

            .message {
                max-width: 90%;
                padding: 12px 16px;
            }

            #chat-header {
                padding: 14px 20px;
                font-size: 1.1em;
            }

            #user-input {
                padding: 12px 16px;
            }
        }

        /* Adaptación para incrustación en Wix */
        .wix-embed {
            width: 100%;
            height: 100%;
            min-height: 600px;
        }
    </style>
</head>
<body>
    <div id="chat-container" class="wix-embed">
        <div id="chat-header">
            <i class="fas fa-headset"></i>
            Asistente de Capacitación | Instituto Tecnipro
        </div>
        <div id="chat-output">
            <div class="message ai-message"><strong>Asesor:</strong> ¡Hola! Soy el asistente de capacitación de Instituto Tecnipro. Puedo ayudarte a encontrar la mejor solución de formación para tu empresa. ¿En qué área específica necesitas capacitar a tu equipo?</div>
        </div>
        <div id="loading-container">
            <div id="loading-animation">
                <div class="typing-indicator">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            </div>
            <div id="loading-text">Preparando información para ti...</div>
        </div>
        <div id="chat-input-area">
            <input type="text" id="user-input" placeholder="Escribe tu consulta sobre capacitaciones...">
            <button id="send-button">
                <span>Enviar</span>
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>

    <script>
        // JavaScript para la lógica del chat
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const chatOutput = document.getElementById('chat-output');
        const loadingContainer = document.getElementById('loading-container');
        const loadingText = document.getElementById('loading-text');

        // URL del flujo de Power Automate
        const POWER_AUTOMATE_FLOW_URL = 'https://prod-48.westus.logic.azure.com:443/workflows/422eff426bf446beb5e4779f6da59075/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=jywG9ryTgzuN1LxQrRY0r87j6Wioqjtug5bNnqLbQT8';

        // Mensajes informativos durante la espera - orientados a encargados de capacitación
        const thinkingMessages = [
            "¿Sabías que nuestras capacitaciones incluyen certificación y respaldo académico?",
            "Contamos con más de 10 años formando profesionales en las principales empresas de Chile",
            "Todas nuestras capacitaciones pueden ser bonificadas por SENCE",
            "Diseñamos programas personalizados según las necesidades específicas de tu empresa",
            "Nuestros relatores son profesionales con amplia experiencia en el sector empresarial",
            "Ofrecemos modalidades presenciales, online en vivo y cursos asincrónicos a tu medida",
            "Podemos adaptar nuestros contenidos a los procesos específicos de tu organización",
            "Nuestras capacitaciones incluyen evaluaciones y reportes de desempeño detallados",
            "La duración de nuestros programas va desde 8 horas hasta diplomados completos",
            "Te asesoramos en todo el proceso administrativo con SENCE y OTIC"
        ];

        // Función para añadir un mensaje al chat
        function addMessage(sender, text) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message');
            
            if (sender === 'user') {
                messageElement.classList.add('user-message');
                messageElement.innerHTML = `<strong>Tú:</strong> ${escapeHTML(text)}`;
            } else {
                messageElement.classList.add('ai-message');
                messageElement.innerHTML = `<strong>Asesor:</strong> ${escapeHTML(text)}`;
            }
            
            chatOutput.appendChild(messageElement);
            chatOutput.scrollTop = chatOutput.scrollHeight;
        }

        // Función para escapar HTML y prevenir inyecciones
        function escapeHTML(str) {
            const div = document.createElement('div');
            div.appendChild(document.createTextNode(str));
            return div.innerHTML;
        }

        // Función para mostrar mensajes informativos rotativos durante la carga
        let tipInterval;
        function startRotatingTips() {
            let tipIndex = Math.floor(Math.random() * thinkingMessages.length);
            loadingText.textContent = thinkingMessages[tipIndex];
            
            tipInterval = setInterval(() => {
                tipIndex = (tipIndex + 1) % thinkingMessages.length;
                loadingText.textContent = thinkingMessages[tipIndex];
            }, 5000);
        }

        function stopRotatingTips() {
            clearInterval(tipInterval);
        }

        // Función para enviar el mensaje
        async function sendMessage() {
            const userMessage = userInput.value.trim();

            if (!userMessage) {
                return;
            }

            // Mostrar el mensaje del usuario
            addMessage('user', userMessage);

            // Preparar la interfaz para esperar la respuesta
            userInput.value = '';
            sendButton.disabled = true;
            
            // Mostrar animación de carga con mensajes informativos rotativos
            loadingContainer.style.display = 'flex';
            startRotatingTips();

            try {
                // Enviar el mensaje a Power Automate
                const requestBody = {
                    message: userMessage
                };

                console.log("Enviando solicitud a:", POWER_AUTOMATE_FLOW_URL);
                
                const response = await fetch(POWER_AUTOMATE_FLOW_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                console.log("Respuesta recibida. Status:", response.status);
                
                // Procesar la respuesta
                if (response.ok) {
                    let aiResponseText;
                    
                    // Intentar procesar como JSON primero
                    try {
                        const jsonResponse = await response.json();
                        console.log("Respuesta JSON:", jsonResponse);
                        
                        // Extraer el mensaje del JSON si existe
                        if (typeof jsonResponse === 'object') {
                            aiResponseText = jsonResponse.message || jsonResponse.response || jsonResponse.text || JSON.stringify(jsonResponse);
                        } else {
                            aiResponseText = String(jsonResponse);
                        }
                    } catch (e) {
                        // Si no es JSON, tratar como texto
                        aiResponseText = await response.text();
                        console.log("Respuesta texto:", aiResponseText);
                    }
                    
                    // Mostrar la respuesta del asesor
                    addMessage('ai', aiResponseText);
                } else {
                    // Manejar errores HTTP
                    console.error("Error HTTP:", response.status, response.statusText);
                    
                    let errorMessage;
                    switch(response.status) {
                        case 401:
                            errorMessage = "Lo sentimos, hubo un problema de autenticación con nuestro servicio.";
                            break;
                        case 403:
                            errorMessage = "No se tiene permiso para acceder a este servicio.";
                            break;
                        case 404:
                            errorMessage = "No se encontró el servicio. Por favor, intente más tarde.";
                            break;
                        case 429:
                            errorMessage = "Estamos experimentando un alto volumen de consultas. Por favor, intente nuevamente en unos momentos.";
                            break;
                        case 500: case 502: case 503: case 504:
                            errorMessage = "Nuestro servicio está experimentando dificultades técnicas. Por favor, intente más tarde o contáctenos directamente.";
                            break;
                        default:
                            errorMessage = "Hubo un problema al procesar su solicitud. Por favor, intente nuevamente.";
                    }
                    
                    addMessage('ai', errorMessage);
                }
            } catch (error) {
                console.error("Error en la conexión:", error);
                addMessage('ai', "Lo sentimos, no pudimos conectar con nuestro servicio. Verifique su conexión a internet o contáctenos directamente por teléfono.");
            } finally {
                // Restablecer la interfaz
                stopRotatingTips();
                loadingContainer.style.display = 'none';
                sendButton.disabled = false;
                userInput.focus();
            }
        }

        // Eventos
        sendButton.addEventListener('click', sendMessage);

        userInput.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                sendMessage();
            }
        });

        // Inicialización
        window.addEventListener('load', () => {
            userInput.focus();
        });
    </script>
</body>
</html>
